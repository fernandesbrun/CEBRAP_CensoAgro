---
title: "Censo Agro - Comparação do VP/área útil"
output:
  html_document:
    toc: true
    toc_depth: 4 
    toc_float: 
      collapsed: false
    theme: flatly  

---

```{r setup, include=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
               cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```


```{r Pacotes, message=FALSE, warning=FALSE, include=FALSE}
#pacotes

#install.packages(c("ggthemes", "ggpubr", "readr", "readxl", "rstatix", "sp", "sf", "tmap", "leaflet", "arsenal", "knitr", "plotly", "kableExtra", "prettydoc", "rmdformats", "knitr", "scales", "esquisse", "pacman"))

#install.packages(c(	"broom", "cli", "crayon" , "dbplyr", "dplyr", "forcats", "ggplot2", "haven", "hms", "httr", "jsonlite", "lubridate", "magrittr", "modelr", "pillar", "purrr", "readr", "readxl", "reprex", "rlang", "rstudioapi", "rvest", "stringr", "tibble", "tidyr", "xml2", "corrplot"))

##install.packages("factoextra")
##install.packages("qwraps2")

pacman::p_load(ggthemes, ggpubr, tidyverse, readr, readxl, esquisse, rstatix, sp, sf, tmap, leaflet, arsenal, knitr, plotly, kableExtra, prettydoc, rmdformats, knitr, scales, broom, cli, crayon , dbplyr, dplyr, forcats, ggplot2, haven, hms, httr, jsonlite, lubridate, magrittr, modelr, pillar, purrr, readr, readxl, reprex, rlang, rstudioapi, rvest, stringr, tibble, tidyr, xml2, factoextra, qwraps2, corrplot) 


options(scipen=999)

```


```{r COD_Tabelas, message=FALSE, warning=FALSE, include=FALSE}
#### TABELAS -----------------
TABELA2 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6878_MUN_areaestabelecimentos+niveis.xlsx", na = "X") 
TABELA2$COD[TABELA2$NIVEL == "BR"] <- 000

TABELA6 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6898_MUN_valordaproducao+niveis.xlsx", na = "X") 
TABELA6$COD[TABELA6$NIVEL == "BR"] <- 000
TABELA6 <- TABELA6 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)
# 
# 
# TABELA8 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6901_MUN_valorreceitas+niveis.xlsx", na = "X") 
# TABELA8$COD[TABELA8$NIVEL == "BR"] <- 000
# TABELA8 <- TABELA8 %>%
#   select(., -NIVEL) %>% 
#   select(., -LOCALIZACAO)

TABELA9 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6882_MUN_areapreservacao+niveis.xlsx", na = "X")
TABELA9$COD[TABELA9$NIVEL == "BR"] <- 000
TABELA9 <- TABELA9 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

TABELA10 <- read_excel("data/tabelas/micro_meso_uf_macro_brasil/communicipio/6788_MUN_totalestabelecimentos+niveis.xlsx", na = "X") 
TABELA10$COD[TABELA10$NIVEL == "BR"] <- 000
TABELA10 <- TABELA10 %>%
  select(., -NIVEL) %>% 
  select(., -LOCALIZACAO)

```

```{r COD_Procedimentos com as tabelas, message=FALSE, warning=FALSE, include=FALSE}
#### PROCEDIMENTOS COM AS TABELAS -----------------

#Join de todas as tabelas 
todastabelas <- TABELA2 %>%
  left_join(., TABELA6, by = "COD") %>%
  # left_join(., TABELA8, by = "COD") %>%
  left_join(., TABELA9, by = "COD") %>%
  left_join(., TABELA10, by = "COD") %>%
  mutate_if(is.numeric , replace_na, replace = 0)


#Filtragem por recorte geográfico
municipios <- todastabelas %>% filter(NIVEL == "MU")
microrregioes <- todastabelas %>% filter(NIVEL == "MI")
mesorregioes <- todastabelas %>% filter(NIVEL == "ME")
estados <- todastabelas %>% filter(NIVEL == "UF")
macrorregioes <- todastabelas %>% filter(NIVEL == "GR")
brasil <- todastabelas %>% filter(NIVEL == "BR")


#Criando colunas de código do estado e da região - MUNICIPIOS
municipios <- municipios %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
municipios$COD_ESTADO <- substr(municipios$COD_ESTADO, 0, 2)
municipios$COD_REGIAO <- substr(municipios$COD_REGIAO, 0, 1)
municipios$COD_REGIAO[municipios$COD_REGIAO == "1"] <- "Norte"
municipios$COD_REGIAO[municipios$COD_REGIAO == "2"] <- "Nordeste"
municipios$COD_REGIAO[municipios$COD_REGIAO == "3"] <- "Sudeste"
municipios$COD_REGIAO[municipios$COD_REGIAO == "4"] <- "Sul"
municipios$COD_REGIAO[municipios$COD_REGIAO == "5"] <- "Centro-Oeste"


#Criando colunas de código do estado e da região 
microrregioes <- microrregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
microrregioes$COD_ESTADO <- substr(microrregioes$COD_ESTADO, 0, 2)
microrregioes$COD_REGIAO <- substr(microrregioes$COD_REGIAO, 0, 1)
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "1"] <- "Norte"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "2"] <- "Nordeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "3"] <- "Sudeste"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "4"] <- "Sul"
microrregioes$COD_REGIAO[microrregioes$COD_REGIAO == "5"] <- "Centro-Oeste"


mesorregioes <- mesorregioes %>%
  mutate(COD_ESTADO = COD, 
         COD_REGIAO = COD)
mesorregioes$COD_ESTADO <- substr(mesorregioes$COD_ESTADO, 0, 2)
mesorregioes$COD_REGIAO <- substr(mesorregioes$COD_REGIAO, 0, 1)


```

```{r COD_Novas colunas2, message=FALSE, warning=FALSE, include=FALSE}
#### CÁLCULO DAS PORCENTAGENS -----------------
microrregioes <- microrregioes %>%
  mutate(#Valor da produção por área útil
    TT_VPdivAREA = (VP_T*1000) / (AREA_T - AREAPRESERV_T), 
    AF_VPdivAREA = (VP_AF*1000) / (AREA_AF - AREAPRESERV_AF),
    MP_VPdivAREA = (VP_MP*1000) / (AREA_MP - AREAPRESERV_MP),
    NAF_VPdivAREA = ((VP_T - VP_AF)*1000) / ((AREA_T - AREA_AF) - AREAPRESERV_GP)
)

municipios <- municipios %>%
  mutate(#Valor da produção por área útil
    TT_VPdivAREA = (VP_T*1000) / (AREA_T - AREAPRESERV_T), 
    AF_VPdivAREA = (VP_AF*1000) / (AREA_AF - AREAPRESERV_AF),
    MP_VPdivAREA = (VP_MP*1000) / (AREA_MP - AREAPRESERV_MP),
    NAF_VPdivAREA = ((VP_T - VP_AF)*1000) / ((AREA_T - AREA_AF) - AREAPRESERV_GP)
)

```


# Introdução

O presente documento tem como objetivo comparar o valor da produção (VP) por área útil (área do estabelecimento exceto áreas destinadas a preservação ambiental) obtido nos estabelecimentos agropecuários da agricultura familiar e não familiar, com a média e mediana obtidas pelo conjunto total dos estabelecimentos agropecuários no país.

A variável criada tem como origem o Censo Agropecuário de 2017, sendo o quociente entre a variável de nome "Valor da produção dos estabelecimentos agropecuários (Mil Reais)" e a variável de área dos estabelecimentos, exceto as destinadas à preservação ambiental (obtida pela diferença entre a variável de nome "Área dos estabelecimentos agropecuários" e a de nome "Utilização das terras, área de matas ou florestas naturais destinadas à preservação permanente ou reserva legal").

<br>

## Metodologia
O trabalho está dividido em duas seçoes principais, por unidade espacial de análise (município ou microrregião) e por tipologia do estabelecimento dentro de cada uma dessas unidades (agricultura familiar e agricultura não familiar).


**Para a agricultura familiar**
A unidade espacial analisada (municípios ou microrregiões) foi classificada dentre três categorias possíveis:

- VP/área útil obtido pelos estabelecimentos da AF na unidade espacial possuem valor abaixo da mediana do valor da produção obtido por todos os estabelecimentos do país;
- VP/área útil obtido pelos estabelecimentos da AF na unidade espacial possuem valor entre a mediana e a média do valor da produção obtido por todos os estabelecimentos do país;
- VP/área útil obtido pelos estabelecimentos da AF na unidade espacial possuem valor acima da média do valor da produção obtido por todos os estabelecimentos do país 


**Para a agricultura não familiar**
A unidade espacial analisada (municípios ou microrregiões) foi classificada dentre três categorias possíveis:

- VP/área útil obtido pelos estabelecimentos da não-AF na unidade espacial possuem valor abaixo da mediana do valor da produção obtido por todos os estabelecimentos do país; 
- VP/área útil obtido pelos estabelecimentos da não-AF na unidade espacial possuem valor entre a mediana e a média do valor da produção obtido por todos os estabelecimentos do país; 
- VP/área útil obtido pelos estabelecimentos da não-AF na unidade espacial possuem valor acima da média do valor da produção obtido por todos os estabelecimentos do país 


```{r COD_Novas colunas, message=FALSE, warning=FALSE, include=FALSE}

#### Municípios ####

municipios <- municipios %>%
  mutate(PAIS = "Brasil") %>%
  group_by(NIVEL, COD, LOCALIZACAO, PAIS, COD_ESTADO, COD_REGIAO) %>%
  select(TT_VPdivAREA,
         AF_VPdivAREA,
         NAF_VPdivAREA)
 

media_brasilMUN <- municipios %>%
  mutate(PAIS = "Brasil") %>%
  group_by(PAIS) %>%
  select(TT_VPdivAREA,
         AF_VPdivAREA,
         NAF_VPdivAREA) %>%
  summarise(
    VPdivAREA_BRA_mean_T = mean(TT_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_mean_AF = mean(AF_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_mean_NAF = mean(NAF_VPdivAREA, na.rm = TRUE),
    
    VPdivAREA_BRA_median_T = median(TT_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_median_AF = median(AF_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_median_NAF = median(NAF_VPdivAREA, na.rm = TRUE)
  )


municipios_all <- municipios %>%
  left_join(., media_brasilMUN, by = "PAIS") 
# %>%
#   left_join(., media_regiaoMUN, by = "COD_REGIAO") %>%
#   left_join(., media_estadoMUN, by = "COD_ESTADO")


#### Microrregiões ####

microrregioes <- microrregioes %>%
  mutate(PAIS = "Brasil") %>%
  group_by(NIVEL, COD, LOCALIZACAO, PAIS, COD_ESTADO, COD_REGIAO) %>%
  select(TT_VPdivAREA,
         AF_VPdivAREA,
         NAF_VPdivAREA)



media_brasilMIC <- microrregioes %>%
  mutate(PAIS = "Brasil") %>%
  group_by(PAIS) %>%
  select(TT_VPdivAREA,
         AF_VPdivAREA,
         NAF_VPdivAREA) %>%
  summarise(
    VPdivAREA_BRA_mean_T = mean(TT_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_mean_AF = mean(AF_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_mean_NAF = mean(NAF_VPdivAREA, na.rm = TRUE),
    
    VPdivAREA_BRA_median_T = median(TT_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_median_AF = median(AF_VPdivAREA, na.rm = TRUE),
    VPdivAREA_BRA_median_NAF = median(NAF_VPdivAREA, na.rm = TRUE)
  )


microrregioes_all <- microrregioes %>%
  left_join(., media_brasilMIC, by = "PAIS") 
# %>%
#   left_join(., media_regiaoMIC, by = "COD_REGIAO") %>%
#   left_join(., media_estadoMIC, by = "COD_ESTADO") 

```

```{r CALCULO_CLASSIFICACOES, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}
municipios_class <- municipios_all %>%
  mutate(
    classVPdivAREA_BRA_AF_T = case_when(
      AF_VPdivAREA < VPdivAREA_BRA_median_T ~ "Abaixo da mediana do país",
      AF_VPdivAREA >= VPdivAREA_BRA_median_T & AF_VPdivAREA <= VPdivAREA_BRA_mean_T ~ "Entre a média e a mediana do país",
      AF_VPdivAREA > VPdivAREA_BRA_mean_T ~ "Acima da média do país"),
    
    classVPdivAREA_BRA_NAF_T = case_when(
      NAF_VPdivAREA < VPdivAREA_BRA_median_T ~ "Abaixo da mediana do país",
      NAF_VPdivAREA >= VPdivAREA_BRA_median_T & NAF_VPdivAREA <= VPdivAREA_BRA_mean_T ~ "Entre a média e a mediana do país",
      NAF_VPdivAREA > VPdivAREA_BRA_mean_T ~ "Acima da média do país"))
    


microrregioes_class <- microrregioes_all %>%
  mutate(
    classVPdivAREA_BRA_AF_T = case_when(
      AF_VPdivAREA < VPdivAREA_BRA_median_T ~ "Abaixo da mediana do país",
      AF_VPdivAREA >= VPdivAREA_BRA_median_T & AF_VPdivAREA <= VPdivAREA_BRA_mean_T ~ "Entre a média e a mediana do país",
      AF_VPdivAREA > VPdivAREA_BRA_mean_T ~ "Acima da média do país"),
    
    classVPdivAREA_BRA_NAF_T = case_when(
      NAF_VPdivAREA < VPdivAREA_BRA_median_T ~ "Abaixo da mediana do país",
      NAF_VPdivAREA >= VPdivAREA_BRA_median_T & NAF_VPdivAREA <= VPdivAREA_BRA_mean_T ~ "Entre a média e a mediana do país",
      NAF_VPdivAREA > VPdivAREA_BRA_mean_T ~ "Acima da média do país"))

microrregioes_class <- as.data.frame(microrregioes_class)

```

```{r shapefiles, message=FALSE, warning=FALSE, include=FALSE, message=FALSE, warning=FALSE, include=FALSE}
SHP_Microrregioes <- read_sf("data/shapes/BR_Microrregioes_2019_simplif.shp")
SHP_Municipios <- read_sf("data/shapes/BR_Municipios_2020_simplif.shp")
SHP_Estados <- read_sf("data/shapes/estados_2010_simplif.shp")
st_crs(SHP_Microrregioes)
tmap_mode("view")

# Mudando o nome pra ficar igual ao da tabela
names(SHP_Microrregioes)[1] <- "COD"
names(SHP_Municipios)[1] <- "COD"


SHP_Microrregioes_class <- left_join(SHP_Microrregioes, microrregioes_class, by = "COD")
SHP_Municipios_class <- left_join(SHP_Municipios, municipios_class, by = "COD")

#SHP_Microrregioes_class <- read_sf("data/shapes/SHP_Municipios_class.gpkg")

```

# Por Municípios

A média brasileira por municípios, considerando o VP/área útil de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMUN[1,]$VPdivAREA_BRA_mean_T, 1))`.

A mediana brasileira por municípios, considerando o VP/área útil de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMUN[1,]$VPdivAREA_BRA_median_T, 1))`.


## Agricultura familiar


**Resumo por região**

```{r tabelaresumo_municipios_AF, echo=FALSE, message=FALSE, warning=FALSE}

municipios_class_sumario <- municipios_class %>%
  select(COD_REGIAO, classVPdivAREA_BRA_AF_T) %>%
  group_by(COD_REGIAO, classVPdivAREA_BRA_AF_T) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classVPdivAREA_BRA_AF_T, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Abaixo da mediana do país`,
         `pct_Abaixo da mediana do país`,
         `n_Entre a média e a mediana do país`,
         `pct_Entre a média e a mediana do país`,
         `n_Acima da média do país`,
         `pct_Acima da média do país`) 


options(knitr.kable.NA = 'Não há')


kbl(municipios_class_sumario,
    col.names = c("Região",
                  "Nº de municípios",
                  "% na região",
                  "Nº de municipios",
                  "% na região",
                  "Nº de municipios",
                  "% na região"),
    align = "crlrlrl",
    caption = "Resumo por região") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "VP/área útil da AF abaixo da mediana do país" = 2, "VP/área útil da AF entre a média e a mediana do país" = 2, "VP/área útil da AF acima da média do país" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos da AF em relação a média e mediana gerais do país" = 6)) 
  #row_spec(6, bold = T, color = "black")


```

**Representação espacial**

```{r mapa_municipios_AF, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#d95f02", "#e6ab02", "#1b9e77")

SHP_Municipios_class$classVPdivAREA_BRA_AF_T <- factor(SHP_Municipios_class$classVPdivAREA_BRA_AF_T, levels = c("Abaixo da mediana do país", 
                                                                                                    "Entre a média e a mediana do país",
                                                                                                    "Acima da média do país")
                                                 )

tmap_options(check.and.fix = TRUE)

SHP_Municipios_class %>%
  filter(!is.na(classVPdivAREA_BRA_AF_T)) %>%
  tm_shape() +
  tm_fill(col = "classVPdivAREA_BRA_AF_T", 
          palette = cores,
          title = "VP/área útil na AF",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 
```

<br>

<br>



## Agricultura não familiar


**Resumo por região**

```{r tabelaresumo_municipios_NAF, echo=FALSE, message=FALSE, warning=FALSE}

municipios_class_sumario_NAF <- municipios_class %>%
  select(COD_REGIAO, classVPdivAREA_BRA_NAF_T) %>%
  group_by(COD_REGIAO, classVPdivAREA_BRA_NAF_T) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classVPdivAREA_BRA_NAF_T, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Abaixo da mediana do país`,
         `pct_Abaixo da mediana do país`,
         `n_Entre a média e a mediana do país`,
         `pct_Entre a média e a mediana do país`,
         `n_Acima da média do país`,
         `pct_Acima da média do país`) 


options(knitr.kable.NA = 'Não há')


kbl(municipios_class_sumario_NAF,
    col.names = c("Região",
                  "Nº de municípios",
                  "% na região",
                  "Nº de municipios",
                  "% na região",
                  "Nº de municipios",
                  "% na região"),
    align = "crlrlrl",
    caption = "Resumo por região") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "VP/área útil não-AF abaixo da mediana do país" = 2, "VP/área útil não-AF entre a média e a mediana do país" = 2, "VP/área útil não-AF acima da média do país" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos não familiares em relação a média e mediana gerais do país" = 6)) 


```

**Representação espacial**

```{r mapa_municipios_NAF, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#d95f02", "#e6ab02", "#1b9e77")

SHP_Municipios_class$classVPdivAREA_BRA_NAF_T <- factor(SHP_Municipios_class$classVPdivAREA_BRA_NAF_T, levels = c("Abaixo da mediana do país", 
                                                                                                    "Entre a média e a mediana do país",
                                                                                                    "Acima da média do país")
                                                 )


  SHP_Municipios_class %>%
  filter(!is.na(classVPdivAREA_BRA_NAF_T)) %>%
  tm_shape() +
  tm_fill(col = "classVPdivAREA_BRA_NAF_T", 
          palette = cores,
          title = "VP/área útil nos não familiares",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 
```



















# Por Microrregiões

A média brasileira por microrregiões, considerando o VP/área útil de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMIC[1,]$VPdivAREA_BRA_mean_T, 1))`.

A mediana brasileira por municípios, considerando o VP/área útil de todos os estabelecimentos agropecuários no ano de referência, é de `r paste("R$",round(media_brasilMIC[1,]$VPdivAREA_BRA_median_T, 1))`.



## Agricultura familiar


**Resumo por região**

```{r tabelaresumo_microrregioes_AF, echo=FALSE, message=FALSE, warning=FALSE}

microrregioes_class_sumario <- microrregioes_class %>%
  select(COD_REGIAO, classVPdivAREA_BRA_AF_T) %>%
  group_by(COD_REGIAO, classVPdivAREA_BRA_AF_T) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classVPdivAREA_BRA_AF_T, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Abaixo da mediana do país`,
         `pct_Abaixo da mediana do país`,
         `n_Entre a média e a mediana do país`,
         `pct_Entre a média e a mediana do país`,
         `n_Acima da média do país`,
         `pct_Acima da média do país`) 


options(knitr.kable.NA = 'Não há')


kbl(microrregioes_class_sumario,
    col.names = c("Região",
                  "Nº de micro",
                  "% na região",
                  "Nº de micro",
                  "% na região",
                  "Nº de micro",
                  "% na região"),
    align = "crlrlrl",
    caption = "Resumo por região - Unidade espacial da microrregião") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "VP/área útil da AF abaixo da mediana do país" = 2, "VP/área útil da AF entre a média e a mediana do país" = 2, "VP/área útil da AF acima da média do país" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos da AF em relação a média e mediana gerais do país" = 6)) 
  #row_spec(6, bold = T, color = "black")


```

**Representação espacial**

```{r mapa_microrregioes_AF, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#d95f02", "#e6ab02", "#1b9e77")

SHP_Microrregioes_class$classVPdivAREA_BRA_AF_T <- factor(SHP_Microrregioes_class$classVPdivAREA_BRA_AF_T, levels = c("Abaixo da mediana do país", 
                                                                                                    "Entre a média e a mediana do país",
                                                                                                    "Acima da média do país")
                                                 )


SHP_Microrregioes_class <- SHP_Microrregioes_class[!st_is_empty(SHP_Microrregioes_class),,drop=FALSE]

SHP_Microrregioes_class %>%
  filter(!is.na(classVPdivAREA_BRA_AF_T)) %>%
  tm_shape() +
  tm_fill(col = "classVPdivAREA_BRA_AF_T", 
          palette = cores,
          title = "VP/área útil na AF",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 




```

<br>

<br>



## Agricultura não familiar


**Resumo por região**

```{r tabelaresumo_microrregioes_NAF, echo=FALSE, message=FALSE, warning=FALSE}

microrregioes_class_sumario_NAF <- microrregioes_class %>%
  select(COD_REGIAO, classVPdivAREA_BRA_NAF_T) %>%
  group_by(COD_REGIAO, classVPdivAREA_BRA_NAF_T) %>%
  summarise(n = n()) %>%
  mutate(pct = n/sum(n)) %>%
  mutate(pct = scales::percent(pct, big.mark = ".",  decimal.mark = "," , na.rm = TRUE, accuracy = 0.1)) %>%
  
  pivot_wider(names_from = classVPdivAREA_BRA_NAF_T, 
              values_from = c(n, pct)) %>%
  select(COD_REGIAO,
         `n_Abaixo da mediana do país`,
         `pct_Abaixo da mediana do país`,
         `n_Entre a média e a mediana do país`,
         `pct_Entre a média e a mediana do país`,
         `n_Acima da média do país`,
         `pct_Acima da média do país`) 


options(knitr.kable.NA = 'Não há')


kbl(microrregioes_class_sumario_NAF,
    col.names = c("Região",
                  "Nº de micro",
                  "% na região",
                  "Nº de micro",
                  "% na região",
                  "Nº de micro",
                  "% na região"),
    align = "crlrlrl",
    caption = "Resumo por região - Unidade espacial da microrregião") %>%
  #kable_classic() %>%
#  kable_minimal() %>%
  #kable_material(c("striped", "hover")) 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c(" " = 1, "VP/área útil não-AF abaixo da mediana do país" = 2, "VP/área útil não-AF entre a média e a mediana do país" = 2, "VP/área útil não-AF acima da média do país" = 2)) %>%
  add_header_above(c(" " = 1, "Posição dos estabelecimentos não familiares em relação a média e mediana gerais do país" = 6)) 


```

**Representação espacial**

```{r mapa_microrregioes_NAF, echo=FALSE, message=FALSE, warning=FALSE}

cores <- c("#d95f02", "#e6ab02", "#1b9e77")

SHP_Microrregioes_class$classVPdivAREA_BRA_NAF_T <- factor(SHP_Microrregioes_class$classVPdivAREA_BRA_NAF_T, levels = c("Abaixo da mediana do país", 
                                                                                                    "Entre a média e a mediana do país",
                                                                                                    "Acima da média do país")
                                                 )



SHP_Microrregioes_class <- SHP_Microrregioes_class[!st_is_empty(SHP_Microrregioes_class),,drop=FALSE]

SHP_Microrregioes_class %>%
  filter(!is.na(classVPdivAREA_BRA_NAF_T)) %>%
  tm_shape() +
  tm_fill(col = "classVPdivAREA_BRA_NAF_T", 
          palette = cores,
          title = "VP/área útil nos não familiares",
          id = "LOCALIZACAO",
          style = "cat"
          ) +
  tm_borders(lwd = 0.0) +
  tm_view(view.legend.position = c("right", "bottom")) +
  tm_shape(SHP_Estados) +
  tm_layout(frame = FALSE) +
  tm_borders(lwd = 1) 
```

